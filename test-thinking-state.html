<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thinking状态测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 3px;
    }
    .status.thinking {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
    }
    .status.available {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
    }
    .status.blocked {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    button.primary {
      background-color: #007bff;
      color: white;
    }
    button.secondary {
      background-color: #6c757d;
      color: white;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Thinking状态跨标签页管理测试</h1>
  
  <div class="test-section">
    <h2>当前状态</h2>
    <div id="status" class="status available">状态：可用</div>
    <div>标签页ID: <span id="tab-id"></span></div>
    <div>当前时间: <span id="current-time"></span></div>
  </div>

  <div class="test-section">
    <h2>操作测试</h2>
    <button id="start-thinking" class="primary">开始Thinking</button>
    <button id="stop-thinking" class="secondary">停止Thinking</button>
    <button id="check-state" class="secondary">检查状态</button>
    <button id="clear-all" class="secondary">清除所有状态</button>
  </div>

  <div class="test-section">
    <h2>测试说明</h2>
    <ol>
      <li>打开多个此页面的标签页</li>
      <li>在一个标签页点击"开始Thinking"</li>
      <li>在其他标签页观察状态变化</li>
      <li>尝试在其他标签页点击"开始Thinking"（应该被阻止）</li>
      <li>回到第一个标签页点击"停止Thinking"</li>
      <li>验证其他标签页恢复可用状态</li>
    </ol>
  </div>

  <div class="test-section">
    <h2>日志</h2>
    <div id="log" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px;"></div>
  </div>

  <script>
    // 复制thinking状态管理逻辑
    const tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
    const THINKING_STATE_KEY = 'ai-chatroom-thinking-state';

    function log(message) {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${time}] ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function setThinkingState(isThinking) {
      try {
        if (isThinking) {
          localStorage.setItem(THINKING_STATE_KEY, JSON.stringify({
            tabId: tabId,
            timestamp: Date.now()
          }));
          log(`设置thinking状态 (tabId: ${tabId})`);
        } else {
          const currentState = localStorage.getItem(THINKING_STATE_KEY);
          if (currentState) {
            const state = JSON.parse(currentState);
            if (state.tabId === tabId) {
              localStorage.removeItem(THINKING_STATE_KEY);
              log(`清除thinking状态 (tabId: ${tabId})`);
            } else {
              log(`无法清除thinking状态 - 不是当前标签页设置的 (当前: ${tabId}, 设置者: ${state.tabId})`);
            }
          }
        }
      } catch (error) {
        log(`状态管理错误: ${error.message}`);
      }
    }

    function isAnyTabThinking() {
      try {
        const currentState = localStorage.getItem(THINKING_STATE_KEY);
        if (!currentState) return false;
        
        const state = JSON.parse(currentState);
        const isExpired = Date.now() - state.timestamp > 30000;
        
        if (isExpired) {
          localStorage.removeItem(THINKING_STATE_KEY);
          log('thinking状态已过期，自动清除');
          return false;
        }
        
        return true;
      } catch (error) {
        log(`检查状态错误: ${error.message}`);
        return false;
      }
    }

    function isCurrentTabThinking() {
      try {
        const currentState = localStorage.getItem(THINKING_STATE_KEY);
        if (!currentState) return false;
        
        const state = JSON.parse(currentState);
        return state.tabId === tabId;
      } catch (error) {
        log(`检查当前标签页状态错误: ${error.message}`);
        return false;
      }
    }

    function updateStatus() {
      const statusDiv = document.getElementById('status');
      const startBtn = document.getElementById('start-thinking');
      const stopBtn = document.getElementById('stop-thinking');
      
      if (isAnyTabThinking()) {
        if (isCurrentTabThinking()) {
          statusDiv.textContent = '状态：当前标签页正在Thinking';
          statusDiv.className = 'status thinking';
          startBtn.disabled = true;
          stopBtn.disabled = false;
        } else {
          statusDiv.textContent = '状态：其他标签页正在Thinking';
          statusDiv.className = 'status blocked';
          startBtn.disabled = true;
          stopBtn.disabled = true;
        }
      } else {
        statusDiv.textContent = '状态：可用';
        statusDiv.className = 'status available';
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    function updateTime() {
      document.getElementById('current-time').textContent = new Date().toLocaleTimeString();
    }

    // 初始化
    document.getElementById('tab-id').textContent = tabId;
    log(`标签页初始化 (tabId: ${tabId})`);

    // 事件监听
    document.getElementById('start-thinking').addEventListener('click', () => {
      if (isAnyTabThinking() && !isCurrentTabThinking()) {
        log('无法开始thinking - 其他标签页正在thinking');
        alert('其他标签页正在thinking，请稍后再试');
        return;
      }
      setThinkingState(true);
      updateStatus();
    });

    document.getElementById('stop-thinking').addEventListener('click', () => {
      setThinkingState(false);
      updateStatus();
    });

    document.getElementById('check-state').addEventListener('click', () => {
      const state = localStorage.getItem(THINKING_STATE_KEY);
      if (state) {
        const parsed = JSON.parse(state);
        log(`当前状态: ${JSON.stringify(parsed)}`);
      } else {
        log('当前状态: 无');
      }
      updateStatus();
    });

    document.getElementById('clear-all').addEventListener('click', () => {
      localStorage.removeItem(THINKING_STATE_KEY);
      log('强制清除所有thinking状态');
      updateStatus();
    });

    // 定期更新
    setInterval(() => {
      updateStatus();
      updateTime();
    }, 1000);

    // 页面卸载时清理
    window.addEventListener('beforeunload', () => {
      setThinkingState(false);
    });

    // 初始更新
    updateStatus();
    updateTime();
  </script>
</body>
</html>
