<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatroom æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .config-form {
            display: grid;
            gap: 10px;
            max-width: 400px;
        }
        .config-form input, .config-form select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>AI Chatroom çº¯å‰ç«¯ç‰ˆ - åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. é…ç½®ç®¡ç†æµ‹è¯•</h2>
        <div class="config-form">
            <input type="text" id="test-api-key" placeholder="æµ‹è¯• API Key" value="test-key-123">
            <input type="text" id="test-base-url" placeholder="Base URL" value="https://api.siliconflow.cn/v1">
            <input type="text" id="test-model" placeholder="æ¨¡å‹åç§°" value="deepseek-ai/DeepSeek-V3">
            <button onclick="testConfigManager()">æµ‹è¯•é…ç½®ç®¡ç†</button>
        </div>
        <div id="config-test-result"></div>
    </div>

    <div class="test-section">
        <h2>2. ä¼šè¯ç®¡ç†æµ‹è¯•</h2>
        <button onclick="testSessionManager()">æµ‹è¯•ä¼šè¯ç®¡ç†</button>
        <div id="session-test-result"></div>
    </div>

    <div class="test-section">
        <h2>3. æœ¬åœ°å­˜å‚¨æµ‹è¯•</h2>
        <button onclick="testLocalStorage()">æµ‹è¯•æœ¬åœ°å­˜å‚¨</button>
        <div id="storage-test-result"></div>
    </div>

    <div class="test-section">
        <h2>4. API è°ƒç”¨æµ‹è¯•ï¼ˆéœ€è¦çœŸå® API Keyï¼‰</h2>
        <div class="info">
            <p>æ³¨æ„ï¼šæ­¤æµ‹è¯•éœ€è¦çœŸå®çš„ API Keyï¼Œä¼šå‘é€å®é™…è¯·æ±‚åˆ° API æœåŠ¡å™¨ã€‚</p>
        </div>
        <div class="config-form">
            <input type="password" id="real-api-key" placeholder="çœŸå® API Key">
            <select id="real-provider">
                <option value="siliconflow">SiliconFlow</option>
                <option value="openai">OpenAI</option>
            </select>
            <button onclick="testApiCall()">æµ‹è¯• API è°ƒç”¨</button>
        </div>
        <div id="api-test-result"></div>
    </div>

    <div class="test-section">
        <h2>5. åº”ç”¨å¯åŠ¨æµ‹è¯•</h2>
        <button onclick="window.open('index.html', '_blank')">æ‰“å¼€ä¸»åº”ç”¨</button>
        <div class="info">
            <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åœ¨æ–°çª—å£ä¸­æ‰“å¼€ä¸»åº”ç”¨è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•ã€‚</p>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="config-manager.js"></script>
    <script src="session-manager.js"></script>

    <script>
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        function testConfigManager() {
            try {
                const apiKey = document.getElementById('test-api-key').value;
                const baseURL = document.getElementById('test-base-url').value;
                const model = document.getElementById('test-model').value;

                // æµ‹è¯•é…ç½®æ›´æ–°
                const config = {
                    apiProvider: 'siliconflow',
                    apiKey: apiKey,
                    baseURL: baseURL,
                    model: model,
                    maxTokens: 2048,
                    temperature: 0.7
                };

                configManager.updateConfig(config);
                
                // æµ‹è¯•é…ç½®è·å–
                const savedConfig = configManager.getConfig();
                
                // æµ‹è¯•é…ç½®éªŒè¯
                const validation = configManager.validateConfig(savedConfig);
                
                if (validation.isValid && savedConfig.apiKey === apiKey) {
                    showResult('config-test-result', 'âœ… é…ç½®ç®¡ç†æµ‹è¯•é€šè¿‡ï¼é…ç½®ä¿å­˜ã€è¯»å–å’ŒéªŒè¯åŠŸèƒ½æ­£å¸¸ã€‚', 'success');
                } else {
                    showResult('config-test-result', 'âŒ é…ç½®ç®¡ç†æµ‹è¯•å¤±è´¥ï¼š' + validation.errors.join(', '), 'error');
                }
            } catch (error) {
                showResult('config-test-result', 'âŒ é…ç½®ç®¡ç†æµ‹è¯•å‡ºé”™ï¼š' + error.message, 'error');
            }
        }

        function testSessionManager() {
            try {
                // åˆ›å»ºæ–°ä¼šè¯
                const session = sessionManager.createSession();
                
                // æ·»åŠ æµ‹è¯•æ¶ˆæ¯
                sessionManager.addMessage('user', 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•ç”¨æˆ·æ¶ˆæ¯');
                sessionManager.addMessage('ai', 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•AIå›å¤');
                
                // è·å–ä¼šè¯
                const currentSession = sessionManager.getCurrentSession();
                
                if (currentSession && currentSession.messages.length === 2) {
                    showResult('session-test-result', 'âœ… ä¼šè¯ç®¡ç†æµ‹è¯•é€šè¿‡ï¼ä¼šè¯åˆ›å»ºã€æ¶ˆæ¯æ·»åŠ åŠŸèƒ½æ­£å¸¸ã€‚', 'success');
                } else {
                    showResult('session-test-result', 'âŒ ä¼šè¯ç®¡ç†æµ‹è¯•å¤±è´¥ï¼šæ¶ˆæ¯æ•°é‡ä¸æ­£ç¡®', 'error');
                }
            } catch (error) {
                showResult('session-test-result', 'âŒ ä¼šè¯ç®¡ç†æµ‹è¯•å‡ºé”™ï¼š' + error.message, 'error');
            }
        }

        function testLocalStorage() {
            try {
                const testKey = 'ai-chatroom-test';
                const testData = { test: true, timestamp: Date.now() };
                
                // æµ‹è¯•å†™å…¥
                localStorage.setItem(testKey, JSON.stringify(testData));
                
                // æµ‹è¯•è¯»å–
                const savedData = JSON.parse(localStorage.getItem(testKey));
                
                // æ¸…ç†æµ‹è¯•æ•°æ®
                localStorage.removeItem(testKey);
                
                if (savedData && savedData.test === true) {
                    showResult('storage-test-result', 'âœ… æœ¬åœ°å­˜å‚¨æµ‹è¯•é€šè¿‡ï¼localStorage è¯»å†™åŠŸèƒ½æ­£å¸¸ã€‚', 'success');
                } else {
                    showResult('storage-test-result', 'âŒ æœ¬åœ°å­˜å‚¨æµ‹è¯•å¤±è´¥ï¼šæ•°æ®ä¸åŒ¹é…', 'error');
                }
            } catch (error) {
                showResult('storage-test-result', 'âŒ æœ¬åœ°å­˜å‚¨æµ‹è¯•å‡ºé”™ï¼š' + error.message, 'error');
            }
        }

        async function testApiCall() {
            const apiKey = document.getElementById('real-api-key').value;
            const provider = document.getElementById('real-provider').value;
            
            if (!apiKey) {
                showResult('api-test-result', 'âŒ è¯·è¾“å…¥ API Key', 'error');
                return;
            }

            try {
                showResult('api-test-result', 'ğŸ”„ æ­£åœ¨æµ‹è¯• API è¿æ¥...', 'info');
                
                const testConfig = {
                    apiProvider: provider,
                    apiKey: apiKey,
                    baseURL: provider === 'siliconflow' ? 'https://api.siliconflow.cn/v1' : 'https://api.openai.com/v1',
                    model: provider === 'siliconflow' ? 'deepseek-ai/DeepSeek-V3' : 'gpt-3.5-turbo',
                    maxTokens: 50,
                    temperature: 0.1
                };

                const result = await configManager.testConnection(testConfig);
                
                if (result.success) {
                    showResult('api-test-result', 'âœ… API è°ƒç”¨æµ‹è¯•é€šè¿‡ï¼è¿æ¥æ­£å¸¸ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚', 'success');
                } else {
                    showResult('api-test-result', 'âŒ API è°ƒç”¨æµ‹è¯•å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                showResult('api-test-result', 'âŒ API è°ƒç”¨æµ‹è¯•å‡ºé”™ï¼š' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        window.addEventListener('load', () => {
            const info = `
                <div class="info">
                    <h3>æµ‹è¯•ç¯å¢ƒä¿¡æ¯ï¼š</h3>
                    <p>æµè§ˆå™¨ï¼š${navigator.userAgent}</p>
                    <p>localStorage æ”¯æŒï¼š${typeof(Storage) !== "undefined" ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
                    <p>Fetch API æ”¯æŒï¼š${typeof(fetch) !== "undefined" ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
                    <p>å½“å‰æ—¶é—´ï¼š${new Date().toLocaleString()}</p>
                </div>
            `;
            document.body.insertAdjacentHTML('afterbegin', info);
        });
    </script>
</body>
</html>
