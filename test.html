<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatroom 测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .config-form {
            display: grid;
            gap: 10px;
            max-width: 400px;
        }
        .config-form input, .config-form select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>AI Chatroom 纯前端版 - 功能测试</h1>
    
    <div class="test-section">
        <h2>1. 配置管理测试</h2>
        <div class="config-form">
            <input type="text" id="test-api-key" placeholder="测试 API Key" value="test-key-123">
            <input type="text" id="test-base-url" placeholder="Base URL" value="https://api.siliconflow.cn/v1">
            <input type="text" id="test-model" placeholder="模型名称" value="deepseek-ai/DeepSeek-V3">
            <button onclick="testConfigManager()">测试配置管理</button>
        </div>
        <div id="config-test-result"></div>
    </div>

    <div class="test-section">
        <h2>2. 会话管理测试</h2>
        <button onclick="testSessionManager()">测试会话管理</button>
        <div id="session-test-result"></div>
    </div>

    <div class="test-section">
        <h2>3. 本地存储测试</h2>
        <button onclick="testLocalStorage()">测试本地存储</button>
        <div id="storage-test-result"></div>
    </div>

    <div class="test-section">
        <h2>4. API 调用测试（需要真实 API Key）</h2>
        <div class="info">
            <p>注意：此测试需要真实的 API Key，会发送实际请求到 API 服务器。</p>
        </div>
        <div class="config-form">
            <input type="password" id="real-api-key" placeholder="真实 API Key">
            <select id="real-provider">
                <option value="siliconflow">SiliconFlow</option>
                <option value="openai">OpenAI</option>
            </select>
            <button onclick="testApiCall()">测试 API 调用</button>
        </div>
        <div id="api-test-result"></div>
    </div>

    <div class="test-section">
        <h2>5. 应用启动测试</h2>
        <button onclick="window.open('index.html', '_blank')">打开主应用</button>
        <div class="info">
            <p>点击上方按钮在新窗口中打开主应用进行手动测试。</p>
        </div>
    </div>

    <!-- 引入必要的脚本 -->
    <script src="config-manager.js"></script>
    <script src="session-manager.js"></script>

    <script>
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        function testConfigManager() {
            try {
                const apiKey = document.getElementById('test-api-key').value;
                const baseURL = document.getElementById('test-base-url').value;
                const model = document.getElementById('test-model').value;

                // 测试配置更新
                const config = {
                    apiProvider: 'siliconflow',
                    apiKey: apiKey,
                    baseURL: baseURL,
                    model: model,
                    maxTokens: 2048,
                    temperature: 0.7
                };

                configManager.updateConfig(config);
                
                // 测试配置获取
                const savedConfig = configManager.getConfig();
                
                // 测试配置验证
                const validation = configManager.validateConfig(savedConfig);
                
                if (validation.isValid && savedConfig.apiKey === apiKey) {
                    showResult('config-test-result', '✅ 配置管理测试通过！配置保存、读取和验证功能正常。', 'success');
                } else {
                    showResult('config-test-result', '❌ 配置管理测试失败：' + validation.errors.join(', '), 'error');
                }
            } catch (error) {
                showResult('config-test-result', '❌ 配置管理测试出错：' + error.message, 'error');
            }
        }

        function testSessionManager() {
            try {
                // 创建新会话
                const session = sessionManager.createSession();
                
                // 添加测试消息
                sessionManager.addMessage('user', '这是一条测试用户消息');
                sessionManager.addMessage('ai', '这是一条测试AI回复');
                
                // 获取会话
                const currentSession = sessionManager.getCurrentSession();
                
                if (currentSession && currentSession.messages.length === 2) {
                    showResult('session-test-result', '✅ 会话管理测试通过！会话创建、消息添加功能正常。', 'success');
                } else {
                    showResult('session-test-result', '❌ 会话管理测试失败：消息数量不正确', 'error');
                }
            } catch (error) {
                showResult('session-test-result', '❌ 会话管理测试出错：' + error.message, 'error');
            }
        }

        function testLocalStorage() {
            try {
                const testKey = 'ai-chatroom-test';
                const testData = { test: true, timestamp: Date.now() };
                
                // 测试写入
                localStorage.setItem(testKey, JSON.stringify(testData));
                
                // 测试读取
                const savedData = JSON.parse(localStorage.getItem(testKey));
                
                // 清理测试数据
                localStorage.removeItem(testKey);
                
                if (savedData && savedData.test === true) {
                    showResult('storage-test-result', '✅ 本地存储测试通过！localStorage 读写功能正常。', 'success');
                } else {
                    showResult('storage-test-result', '❌ 本地存储测试失败：数据不匹配', 'error');
                }
            } catch (error) {
                showResult('storage-test-result', '❌ 本地存储测试出错：' + error.message, 'error');
            }
        }

        async function testApiCall() {
            const apiKey = document.getElementById('real-api-key').value;
            const provider = document.getElementById('real-provider').value;
            
            if (!apiKey) {
                showResult('api-test-result', '❌ 请输入 API Key', 'error');
                return;
            }

            try {
                showResult('api-test-result', '🔄 正在测试 API 连接...', 'info');
                
                const testConfig = {
                    apiProvider: provider,
                    apiKey: apiKey,
                    baseURL: provider === 'siliconflow' ? 'https://api.siliconflow.cn/v1' : 'https://api.openai.com/v1',
                    model: provider === 'siliconflow' ? 'deepseek-ai/DeepSeek-V3' : 'gpt-3.5-turbo',
                    maxTokens: 50,
                    temperature: 0.1
                };

                const result = await configManager.testConnection(testConfig);
                
                if (result.success) {
                    showResult('api-test-result', '✅ API 调用测试通过！连接正常，可以正常使用。', 'success');
                } else {
                    showResult('api-test-result', '❌ API 调用测试失败：' + result.message, 'error');
                }
            } catch (error) {
                showResult('api-test-result', '❌ API 调用测试出错：' + error.message, 'error');
            }
        }

        // 页面加载时显示基本信息
        window.addEventListener('load', () => {
            const info = `
                <div class="info">
                    <h3>测试环境信息：</h3>
                    <p>浏览器：${navigator.userAgent}</p>
                    <p>localStorage 支持：${typeof(Storage) !== "undefined" ? '✅ 是' : '❌ 否'}</p>
                    <p>Fetch API 支持：${typeof(fetch) !== "undefined" ? '✅ 是' : '❌ 否'}</p>
                    <p>当前时间：${new Date().toLocaleString()}</p>
                </div>
            `;
            document.body.insertAdjacentHTML('afterbegin', info);
        });
    </script>
</body>
</html>
